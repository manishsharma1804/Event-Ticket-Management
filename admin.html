<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="styles/admin.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Add Swiper CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- Add this CSS style block in the head section -->
    <style>
        @media screen and (max-width: 768px) {
            .content-section {
                padding-bottom: 80px; /* Add padding at bottom of each section */
                margin-bottom: 20px; /* Additional margin for visual separation */
            }

            /* Ensure the last element in each section has proper spacing */
            .content-section > *:last-child {
                margin-bottom: 60px;
            }

            /* Additional spacing for specific sections that might need more room */
            #verification, #generateTicket, #passes {
                padding-bottom: 100px; /* Extra padding for sections with more interactive elements */
            }

            /* Ensure bottom elements don't get cut off by the mobile nav */
            .button-group, .admin-ticket-actions, .generate-btn {
                margin-bottom: 80px;
            }

            /* Additional spacing for create event form */
            #createEventSection {
                padding-bottom: 120px; /* Extra padding for the create event form */
            }

            /* Ensure form buttons are visible */
            .form-group:last-child {
                margin-bottom: 100px; /* Space for form buttons */
            }

            /* Additional space for buttons when editing */
            .create-btn, .cancel-btn {
                margin-bottom: 20px;
            }

            /* Container for form buttons */
            .form-group[style*="display: flex"] {
                margin-bottom: 120px; /* Extra space for button container */
                padding-bottom: 20px;
            }

            /* Hide event gallery on mobile */
            .event-images {
                display: none;
            }

            /* Optional: Add a message indicating gallery is hidden on mobile */
            .event-images::before {
                content: 'Gallery available on desktop view';
                display: block;
                text-align: center;
                color: #666;
                padding: 10px;
                font-size: 0.9em;
                font-style: italic;
            }

            /* Hide event gallery on mobile - using more specific selector */
            .event-card .event-images,
            .event-card-content .event-images,
            .event-section .event-images {
                display: none !important;
            }

            /* Optional: Add a message indicating gallery is hidden on mobile */
            .event-card .event-images::before,
            .event-card-content .event-images::before,
            .event-section .event-images::before {
                content: 'Gallery available on desktop view';
                display: block;
                text-align: center;
                color: #666;
                padding: 10px;
                font-size: 0.9em;
                font-style: italic;
            }

            /* Hide event gallery on mobile - using all possible combinations */
            .event-images,
            div.event-images,
            .event-card .event-images,
            .event-card-content .event-images,
            .event-section .event-images,
            [class*="event"] .event-images {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            /* Optional: Add a message indicating gallery is hidden on mobile */
            .event-images::before,
            div.event-images::before {
                content: 'Gallery available on desktop view';
                display: block;
                text-align: center;
                color: #666;
                padding: 10px;
                font-size: 0.9em;
                font-style: italic;
            }

            /* Hide event gallery on mobile */
            .events-carousel-section {
                display: none !important;
            }

            /* Optional: Add a message indicating gallery is hidden on mobile */
            .events-carousel-section::before {
                content: 'Gallery available on desktop view';
                display: block;
                text-align: center;
                color: #666;
                padding: 10px;
                font-size: 0.9em;
                font-style: italic;
            }
        }
    </style>
    <!-- Add this near the top with other script imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Initialize jsPDF globally
        window.jsPDF = window.jspdf.jsPDF;
        console.log('jsPDF initialized:', !!window.jsPDF);
    </script>
</head>
<body>
    <!-- Mobile Top Navbar -->
    <div class="mobile-top-nav">
        <div class="mobile-top-title" onclick="window.location.href='index.html'" style="cursor: pointer;">EventTix Admin</div>
        <button onclick="logout()" class="mobile-logout-btn">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2 onclick="window.location.href='index.html'" style="cursor: pointer;">EventTix Admin</h2>
            </div>
            
            <div class="menu">
                <div class="menu-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                
                <div class="menu-item" onclick="showSection('events')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </div>
                
                <div class="menu-item" onclick="showSection('tickets')">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Tickets</span>
                </div>
                
                <div class="menu-item" onclick="showSection('verification')">
                    <i class="fas fa-check-circle"></i>
                    <span>Verify Tickets</span>
                </div>
                
                <div class="menu-item" onclick="showSection('passes')">
                    <i class="fas fa-id-card"></i>
                    <span>Pass Management</span>
                </div>
                
                <div class="menu-item" onclick="showSection('generateTicket')">
                    <i class="fas fa-plus-circle"></i>
                    <span>Generate Ticket</span>
                </div>
                

            </div>
            
            <div class="user-info">
                <span id="userEmail"></span>
                <div class="sidebar-actions">
                    <a href="index.html" class="home-btn" title="Go to Home">
                        
                    </a>
                    <button id="logoutBtn" class="logout-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h2>Dashboard</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Events</h3>
                        <div class="number" id="totalEvents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Upcoming Events</h3>
                        <div class="number" id="upcomingEvents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed Events</h3>
                        <div class="number" id="completedEvents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tickets</h3>
                        <div class="number" id="totalTickets">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Tickets Sold</h3>
                        <div class="number" id="ticketsSold">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Available Tickets</h3>
                        <div class="number" id="availableTickets">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="number" id="totalRevenue">â‚¹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Tickets Scanned</h3>
                        <div class="number" id="ticketsScanned">0</div>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div id="events" class="content-section">
                <h2>Manage Events</h2>
                
                <!-- Add toggle buttons -->
                <div class="events-toggle">
                    <button class="toggle-btn active" onclick="toggleEventsView('view')">
                        <i class="fas fa-list"></i> View Events
                    </button>
                    <button class="toggle-btn" onclick="toggleEventsView('create')">
                        <i class="fas fa-plus"></i> Create Event
                    </button>
                </div>

                <!-- Create Event Form (Initially Hidden) -->
                <div id="createEventSection" class="event-section" style="display: none;">
                    <div class="event-form">
                        <input type="hidden" id="editingEventId">
                        <div class="form-group">
                            <label>Event Name</label>
                            <input type="text" id="eventName" required>
                        </div>
                        <div class="form-group">
                            <label>Event Category</label>
                            <select id="eventCategory" onchange="handleEventCategoryChange()" required>
                                <option value="">Select Category</option>
                                <option value="corporate">Corporate Events</option>
                                <option value="social">Social Events</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="sports">Sports & Fitness</option>
                                <option value="educational">Educational</option>
                                <option value="community">Community Events</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="otherCategoryGroup" style="display: none;">
                            <label>Custom Category Name</label>
                            <input type="text" id="otherCategoryName" placeholder="Enter category name">
                        </div>
                        <div class="form-group">
                            <label>Event Pricing Type</label>
                            <select id="eventPricingType" onchange="handlePricingTypeChange()" required>
                                <option value="">Select Pricing Type</option>
                                <option value="paid">Paid Event</option>
                                <option value="free">Free Event</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventDescription">Event Description</label>
                            <textarea 
                                id="eventDescription" 
                                name="eventDescription" 
                                class="form-textarea" 
                                rows="6" 
                                placeholder="Enter event description" 
                                required></textarea>
                            <div class="helper-text">Enter a detailed description of your event</div>
                        </div>
                        <div class="form-group">
                            <label>Event Date</label>
                            <input type="datetime-local" id="eventDate" required>
                        </div>
                        <!-- Event Scheduling Section -->
                        <div class="scheduling-section">
                            <h3>Event Scheduling</h3>
                            <div class="schedule-checkbox">
                                <input type="checkbox" id="enablePublishSchedule" onchange="toggleScheduleSection('publish')">
                                <label for="enablePublishSchedule">Schedule Event Publishing</label>
                            </div>
                            <div id="publishScheduleSection" class="schedule-details" style="display: none;">
                                <input type="datetime-local" id="publishDate" class="schedule-input">
                                <div class="helper-text">Event will become visible to users at this time</div>
                            </div>
                            
                            <div class="schedule-checkbox">
                                <input type="checkbox" id="enableHideSchedule" onchange="toggleScheduleSection('hide')">
                                <label for="enableHideSchedule">Schedule Event Hiding</label>
                            </div>
                            <div id="hideScheduleSection" class="schedule-details" style="display: none;">
                                <input type="datetime-local" id="hideDate" class="schedule-input">
                                <div class="helper-text">Event will be hidden from users at this time</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Booking Start Date</label>
                            <input type="datetime-local" id="bookingStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>Booking Deadline</label>
                            <input type="datetime-local" id="bookingDeadline" required>
                        </div>
                        <div class="form-group">
                            <label>Price (â‚¹)</label>
                            <input type="number" 
                                   id="eventPrice" 
                                   min="0" 
                                   step="0.01" 
                                   value="0"
                                   required>
                        </div>
                        <div class="form-group">
                            <label class="required">Event Type</label>
                            <select id="eventType" onchange="handleEventTypeChange()" required>
                                <option value="">Select Event Type</option>
                                <option value="venue">Venue (Physical Location)</option>
                                <option value="online">Online Event</option>
                                <option value="hybrid">Hybrid (Both Online & Venue)</option>
                            </select>
                        </div>
                        <div id="onlineEventDetails" class="form-section" style="display: none;">
                            <h3>Online Event Details</h3>
                            <div class="form-group">
                                <label class="required">Meeting Platform</label>
                                <select id="meetingPlatform" required>
                                    <option value="">Select Platform</option>
                                    <option value="zoom">Zoom</option>
                                    <option value="gmeet">Google Meet</option>
                                    <option value="teams">Microsoft Teams</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Meeting Link</label>
                                <input type="url" id="meetingLink" placeholder="https://..." required>
                                <div class="helper-text">This will be shared with attendees after booking</div>
                            </div>
                            <div class="form-group">
                                <label>Meeting ID (if applicable)</label>
                                <input type="text" id="meetingId" placeholder="Meeting ID">
                            </div>
                            <div class="form-group">
                                <label>Meeting Password (if applicable)</label>
                                <input type="text" id="meetingPassword" placeholder="Meeting Password">
                            </div>
                        </div>
                        <div id="venueEventDetails" class="form-section" style="display: none;">
                            <h3>Venue Details</h3>
                            <div class="form-group">
                                <label class="required">Event Place</label>
                                <input type="text" id="eventPlace" placeholder="Enter event location" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Venue Details</label>
                                <textarea id="eventVenue" placeholder="Enter detailed venue information (e.g., hall number, floor, landmarks)" required></textarea>
                            </div>
                        </div>
                        <div id="imageUrlsContainer">
                            <div class="form-group image-input">
                                <label>Image URL #1</label>
                                <input type="text" class="eventImage" placeholder="Enter image URL">
                                <button type="button" onclick="addImageField()" class="add-image-btn">+ Add Another Image</button>
                            </div>
                        </div>
                        <div id="ticketingSection" class="form-section" style="display: none;">
                            <h3>Ticket Configuration</h3>
                            
                            <!-- For non-hybrid events -->
                            <div class="form-group" id="standardTicketsSection">
                                <label class="required">Total Available Tickets</label>
                                <input type="number" id="eventTickets" min="1" required>
                            </div>

                            <!-- For hybrid events -->
                            <div id="hybridTicketsSection" style="display: none;">
                                <div class="form-group" id="venueTicketsSection">
                                    <label class="required">Venue Tickets</label>
                                    <input type="number" id="venueTickets" min="0" required>
                                    <div class="helper-text">Number of tickets available for physical attendance</div>
                                    <div class="form-group">
                                        <label class="required">Venue Ticket Price (â‚¹)</label>
                                        <input type="number" 
                                               id="venueTicketPrice" 
                                               min="0" 
                                               step="0.01" 
                                               value="0"
                                               required>
                                    </div>
                                </div>

                                <div class="form-group" id="onlineTicketsSection">
                                    <label class="required">Online Tickets</label>
                                    <input type="number" id="onlineTickets" min="0" step="0.01" required>
                                    <div class="helper-text">Number of tickets available for online attendance</div>
                                    <div class="form-group">
                                        <label class="required">Online Ticket Price (â‚¹)</label>
                                        <input type="number" 
                                               id="onlineTicketPrice" 
                                               min="0" 
                                               step="0.01" 
                                               value="0"
                                               required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Add this after the event description field in your form -->
                        <div class="form-group">
                            <label>Rules (if applicable)</label>
                            <div 
                                id="eventRules" 
                                name="eventRules" 
                                class="form-textarea" 
                                contenteditable="true" 
                                style="border: 1px solid #ccc; padding: 10px; min-height: 120px;">
                            </div>
                            <div class="helper-text">Add any rules or guidelines for the event</div>
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <button type="button" onclick="handleCreateEvent()" class="create-btn">Create Event</button>
                            <button type="button" onclick="cancelEdit()" class="cancel-btn" style="display: none;">Cancel Edit</button>
                        </div>
                    </div>
                </div>

                <!-- View Events Section (Initially Visible) -->
                <div id="viewEventSection" class="event-section">
                    <!-- Add filter controls -->
                    <div class="event-filters">
                        <input type="text" 
                               id="eventSearchInput" 
                               placeholder="Search events..."
                               oninput="filterEvents()">
                        <select id="eventTypeFilter" onchange="filterEvents()">
                            <option value="">All Types</option>
                            <option value="venue">Venue</option>
                            <option value="online">Online</option>
                            <option value="hybrid">Hybrid</option>
                        </select>
                        <select id="eventStatusFilter" onchange="filterEvents()">
                            <option value="">All Status</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="event-list" id="eventList">
                        <!-- Events will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Tickets Section -->
            <div id="tickets" class="content-section">
                <h2>Ticket Management</h2>
                
                <!-- Stats card with original class names -->
                <div class="stats-card">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h4>Total Tickets</h4>
                            <p id="adminTotalTickets">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Tickets Sold</h4>
                            <p id="adminSoldTickets">0</p>
                        </div>
                        <div class="stat-item">
                            <h4>Available Tickets</h4>
                            <p id="adminAvailableTickets">0</p>
                        </div>
                        <div class="stat-item">
            <h4>Tickets Used</h4>
            <p id="selectedEventUsedTickets">0</p>
        </div>
                        <div class="stat-item">
                            <h4>Total Revenue</h4>
                            <p id="selectedEventTotalRevenue">â‚¹0</p>
                        </div>
                    </div>
                </div>

                <!-- Existing ticket filters and list -->
                <div class="ticket-filters">
                    <select id="adminEventSelector">
                        <option value="">All Events</option>
                    </select>
                    <input type="text" 
                           id="adminTicketSearch" 
                           placeholder="Search tickets...">
                </div>

                <div id="adminTicketList" class="ticket-list">
                    <!-- Tickets will be populated here -->
                </div>
            </div>

            <!-- Verification Section -->
<div id="verification" class="content-section">
    <h2>Ticket Verification</h2>
    
    <div class="verification-tabs">
        <button class="tab-btn active" onclick="switchVerificationMethod('manual')">
            <i class="fas fa-keyboard"></i> Manual Entry
        </button>
        <button class="tab-btn" onclick="switchVerificationMethod('qr')">
            <i class="fas fa-qrcode"></i> Scan QR Code
        </button>
    </div>

    <div id="qrVerification" class="verification-method">
        <div id="qrReader"></div>
        <button class="scan-btn" onclick="startQRScanner()">
            <i class="fas fa-camera"></i> Start Scanner
        </button>
        <button onclick="stopQRScanner()" style="display: none;">Stop Scanner</button>
    </div>

    <div id="manualVerification" class="verification-method" style="display: none;">
        <div class="form-group">
            <label>Enter Ticket ID</label>
            <input type="text" id="ticketIdInput" placeholder="Enter ticket ID">
            <button onclick="verifyTicketManually()">Verify Ticket</button>
        </div>
    </div>

    <div id="verificationResult" class="verification-result" style="display: none;">
        <h3>Verification Result</h3>
        <span class="result-status"></span>
        <div class="ticket-details"></div>
        <button onclick="markTicketAsUsed()" class="mark-used-btn" style="display: none;">
            Mark as Used
        </button>
    </div>
</div>
<!-- Add this new section after your other content sections -->
<div id="passes" class="content-section">
    <h2>Pass Management</h2>
    
    <!-- Stats Section -->
    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item">
                <h4>Total Passes</h4>
                <p id="totalPasses">0</p>
            </div>
            <div class="stat-item">
                <h4>Used Passes</h4>
                <p id="usedPasses">0</p>
            </div>
            <div class="stat-item">
                <h4>Unused Passes</h4>
                <p id="unusedPasses">0</p>
            </div>
        </div>
    </div>

    <!-- Toggle Buttons -->
    <div class="passes-toggle">
        <button class="toggle-btn active" onclick="togglePassesView('generate')">
            Generate Passes
        </button>
        <button class="toggle-btn" onclick="togglePassesView('view')">
            View Passes
        </button>
    </div>

    <!-- Generate Passes Section -->
    <div id="generatePassesSection" class="passes-section">
        <div class="form-group">
            <label>Select Event</label>
            <select id="eventSelectorForPasses" required>
                <option value="">Select an Event</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Role</label>
            <select id="roleSelector" required>
                <option value="">Select Role</option>
                <option value="staff">Staff</option>
                <option value="vip">VIP</option>
                <option value="media">Media</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div class="form-group" id="otherRoleInput" style="display: none;">
            <label>Custom Role</label>
            <input type="text" id="customRole" placeholder="Enter custom role">
        </div>

        <div class="form-group">
            <label>Number of Passes</label>
            <input type="number" id="numberOfPasses" min="1" value="1" required>
        </div>

        <button onclick="generatePasses()" class="generate-btn">Generate Passes</button>

        <div id="generatedPassesList" class="generated-passes">
            <!-- Generated passes will appear here -->
        </div>
    </div>

    <!-- View Passes Section -->
    <div id="viewPassesSection" class="passes-section" style="display: none;">
        <div id="viewPassesList">
            <!-- Existing passes will be listed here -->
        </div>
    </div>
</div>
<!-- Generate Ticket Section -->
<div id="generateTicket" class="content-section">
    <h2>Generate Ticket</h2>
    
    <div class="ticket-generation-form">
        <div class="form-group">
            <label>Select Event</label>
            <select id="ticketEventSelector">
                <option value="">Select an Event</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Ticket Type</label>
            <select id="ticketTypeSelector">
    <option value="">Select Ticket Type</option>
</select>
<small class="helper-text" style="color: #666; font-size: 0.8em; margin-top: 4px; display: block;">
    Ticket types will only appear if tickets are available for the selected event
</small>
        </div>
        
        <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="ticketQuantity" min="1" value="1" required>
        </div>
        
        <div class="form-group">
            <label>User Email</label>
            <input type="email" id="ticketUserEmail" placeholder="Enter user email" required>
        </div>
        <div class="form-group">
            <label>Payment Mode</label>
            <select id="paymentMode" required>
                <option value="">Select Payment Mode</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="free" style="display: none;">Free</option>
            </select>
        </div>
        
        <div class="price-summary">
            <p>Price per ticket: <span id="pricePerTicket">â‚¹0</span></p>
            <p>Total Amount: <span id="totalTicketPrice">â‚¹0</span></p>
        </div>
        
        <button onclick="generateTicketForUser()" class="generate-btn">Generate Ticket</button>
    </div>
</div>




    <script>
    // Navigation
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });

        // Show selected section
        const selectedSection = document.getElementById(sectionId);
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }

        // Update active menu item for both sidebar and mobile nav
        document.querySelectorAll('.menu-item, .mobile-nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // Activate sidebar menu item
        const menuItem = document.querySelector(`.menu-item[onclick*="${sectionId}"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }

        // Activate mobile nav item
        const mobileNavItem = document.querySelector(`.mobile-nav-item[onclick*="${sectionId}"]`);
        if (mobileNavItem) {
            mobileNavItem.classList.add('active');
        }

        // Handle section-specific initialization
        switch (sectionId) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'events':
                loadEvents();
                break;
            case 'tickets':
                loadTickets();
                break;
            case 'verification':
                switchVerificationMethod('manual');
                break;
        }

        // Clean up verification when switching away
        if (sectionId !== 'verification') {
            cleanupVerification();
        }
    }

    // Ensure the dashboard is active on page load
    document.addEventListener('DOMContentLoaded', () => {
        showSection('dashboard');
    });

    

    
        // Format currency in INR
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
    
        // Events Functions
        let imageFieldCount = 1;
    
        function addImageField() {
            imageFieldCount++;
            const container = document.getElementById('imageUrlsContainer');
            const div = document.createElement('div');
            div.className = 'form-group image-input';
            div.innerHTML = `
                <label>Image URL #${imageFieldCount}</label>
                <input type="text" class="eventImage" placeholder="Enter image URL">
                <button type="button" onclick="removeImageField(this)" class="remove-image-btn">Remove</button>
            `;
            container.appendChild(div);
        }
    
        function removeImageField(button) {
            button.parentElement.remove();
            imageFieldCount--;
        }
    
        // Add this variable to track editing state
        let isEditing = false;
        let currentEditingEventId = null;
    
        // Update the edit button click handler
        function openEditModal(eventId, eventData) {
    document.getElementById('editingEventId').value = eventId;
    try {
        console.log("Opening edit modal for event:", eventId);
        console.log("Event data received:", eventData);

        isEditing = true;
        currentEditingEventId = eventId;
        
        // Update buttons
        const cancelBtn = document.querySelector('.cancel-btn');
        const createBtn = document.querySelector('.create-btn');
        if (cancelBtn) cancelBtn.style.display = 'block';
        if (createBtn) createBtn.textContent = 'Update Event';
        
        // Basic event details
        document.getElementById('eventName').value = eventData.name || '';
        document.getElementById('eventCategory').value = eventData.category || '';
        document.getElementById('eventPricingType').value = eventData.pricingType || 'paid';
        
        // Handle pricing type change first
        handlePricingTypeChange();
        
        // Handle custom category
        const otherCategoryGroup = document.getElementById('otherCategoryGroup');
        const otherCategoryInput = document.getElementById('otherCategoryName');
        if (eventData.category === 'other') {
            otherCategoryGroup.style.display = 'block';
            otherCategoryInput.value = eventData.customCategory || '';
        } else {
            otherCategoryGroup.style.display = 'none';
            otherCategoryInput.value = '';
        }

        // Dates
        document.getElementById('eventDate').value = new Date(eventData.date).toISOString().slice(0, 16);
        document.getElementById('bookingStartDate').value = new Date(eventData.bookingStartDate).toISOString().slice(0, 16);
        document.getElementById('bookingDeadline').value = new Date(eventData.bookingDeadline).toISOString().slice(0, 16);
        
        // Event type and related fields
        const eventTypeSelect = document.getElementById('eventType');
        eventTypeSelect.value = eventData.eventType || '';
        handleEventTypeChange();
        
        // Handle pricing based on event type
        if (eventData.eventType === 'hybrid') {
            document.getElementById('venueTickets').value = eventData.tickets?.venue?.total || '';
            document.getElementById('onlineTickets').value = eventData.tickets?.online?.total || '';
            document.getElementById('venueTicketPrice').value = eventData.tickets?.venue?.price || '0';
            document.getElementById('onlineTicketPrice').value = eventData.tickets?.online?.price || '0';
        } else {
            document.getElementById('eventPrice').value = eventData.price || '0';
            document.getElementById('eventTickets').value = eventData.totalTickets || '';
        }

        // Handle online/hybrid event details
        if (eventData.eventType === 'online' || eventData.eventType === 'hybrid') {
            document.getElementById('meetingPlatform').value = eventData.onlineDetails?.platform || '';
            document.getElementById('meetingLink').value = eventData.onlineDetails?.meetingLink || '';
            document.getElementById('meetingId').value = eventData.onlineDetails?.meetingId || '';
            document.getElementById('meetingPassword').value = eventData.onlineDetails?.meetingPassword || '';
        }

        // Handle venue details
        if (eventData.eventType === 'venue' || eventData.eventType === 'hybrid') {
            document.getElementById('eventPlace').value = eventData.venueDetails?.place || '';
            document.getElementById('eventVenue').value = eventData.venueDetails?.venue || '';
        }

        // Handle scheduling data
        if (eventData.scheduling) {
            const publishSchedule = document.getElementById('enablePublishSchedule');
            const hideSchedule = document.getElementById('enableHideSchedule');
            
            if (eventData.scheduling.publishDate) {
                publishSchedule.checked = true;
                document.getElementById('publishScheduleSection').style.display = 'block';
                document.getElementById('publishDate').value = new Date(eventData.scheduling.publishDate).toISOString().slice(0, 16);
            }
            
            if (eventData.scheduling.hideDate) {
                hideSchedule.checked = true;
                document.getElementById('hideScheduleSection').style.display = 'block';
                document.getElementById('hideDate').value = new Date(eventData.scheduling.hideDate).toISOString().slice(0, 16);
            }
        }

        // Handle images
        const imageContainer = document.getElementById('imageUrlsContainer');
        imageContainer.innerHTML = '';
        
        if (eventData.images && Array.isArray(eventData.images)) {
            eventData.images.forEach((imageUrl, index) => {
                const div = document.createElement('div');
                div.className = 'form-group image-input';
                div.innerHTML = `
                    <label>Image URL #${index + 1}</label>
                    <input type="text" class="eventImage" value="${imageUrl}" placeholder="Enter image URL">
                    ${index === 0 ? 
                        `<button type="button" onclick="addImageField()" class="add-image-btn">+ Add Another Image</button>` : 
                        `<button type="button" onclick="removeImageField(this)" class="remove-image-btn">Remove</button>`
                    }
                `;
                imageContainer.appendChild(div);
            });
            imageFieldCount = eventData.images.length;
        } else {
            const div = document.createElement('div');
            div.className = 'form-group image-input';
            div.innerHTML = `
                <label>Image URL #1</label>
                <input type="text" class="eventImage" placeholder="Enter image URL">
                <button type="button" onclick="addImageField()" class="add-image-btn">+ Add Another Image</button>
            `;
            imageContainer.appendChild(div);
            imageFieldCount = 1;
        }

        // Handle description and rules directly
        document.getElementById('eventDescription').value = eventData.description || '';
        document.getElementById('eventRules').innerHTML = eventData.rules || '';

        // Scroll form into view
        document.querySelector('.event-form').scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error("Detailed error opening edit modal:", error);
        alert('Error loading event data for editing: ' + error.message);
    }
}
    
        // Update the handleCreateEvent function to handle both create and update
        async function handleCreateEvent() {
    try {
        if (!validateEventDates()) {
            return;
        }

        const editingEventId = document.getElementById('editingEventId')?.value;
        const isEditing = !!editingEventId;

        const eventData = {
            name: document.getElementById('eventName').value.trim(),
            description: document.getElementById('eventDescription').value.trim(),
            category: document.getElementById('eventCategory').value,
            pricingType: document.getElementById('eventPricingType').value,
            date: new Date(document.getElementById('eventDate').value).toISOString(),
            bookingStartDate: new Date(document.getElementById('bookingStartDate').value).toISOString(),
            bookingDeadline: new Date(document.getElementById('bookingDeadline').value).toISOString(),
            eventType: document.getElementById('eventType').value,
            price: parseFloat(document.getElementById('eventPrice').value) || 0,
            rules: document.getElementById('eventRules').innerHTML.trim(),
            updatedAt: serverTimestamp(),
            
            // Add scheduling if enabled
            scheduling: {
                publishDate: document.getElementById('enablePublishSchedule').checked ? 
                    new Date(document.getElementById('publishDate').value).toISOString() : null,
                hideDate: document.getElementById('enableHideSchedule').checked ? 
                    new Date(document.getElementById('hideDate').value).toISOString() : null
            },

            // Add images
            images: Array.from(document.getElementsByClassName('eventImage'))
                .map(input => input.value.trim())
                .filter(url => url !== '')
        };

        // Only add these fields for new events
        if (!isEditing) {
            eventData.eventId = generateEventId();
            eventData.createdAt = serverTimestamp();
        }

        // Handle custom category
        if (eventData.category === 'other') {
            eventData.customCategory = document.getElementById('otherCategoryName').value.trim();
        }

        // Handle event type specific details
        if (eventData.eventType === 'online' || eventData.eventType === 'hybrid') {
            eventData.onlineDetails = {
                platform: document.getElementById('meetingPlatform').value,
                meetingLink: document.getElementById('meetingLink').value.trim(),
                meetingId: document.getElementById('meetingId').value.trim(),
                meetingPassword: document.getElementById('meetingPassword').value.trim()
            };
        }

        if (eventData.eventType === 'venue' || eventData.eventType === 'hybrid') {
            eventData.venueDetails = {
                place: document.getElementById('eventPlace').value.trim(),
                venue: document.getElementById('eventVenue').value.trim()
            };
        }

        // Handle ticket configuration
        if (eventData.eventType === 'hybrid') {
            eventData.tickets = {
                venue: {
                    total: parseInt(document.getElementById('venueTickets').value) || 0,
                    available: parseInt(document.getElementById('venueTickets').value) || 0,
                    price: parseFloat(document.getElementById('venueTicketPrice').value) || 0
                },
                online: {
                    total: parseInt(document.getElementById('onlineTickets').value) || 0,
                    available: parseInt(document.getElementById('onlineTickets').value) || 0,
                    price: parseFloat(document.getElementById('onlineTicketPrice').value) || 0
                }
            };
        } else {
            eventData.totalTickets = parseInt(document.getElementById('eventTickets').value) || 0;
            eventData.availableTickets = parseInt(document.getElementById('eventTickets').value) || 0;
        }

        // Handle free events
        if (eventData.pricingType === 'free') {
            eventData.price = 0;
            if (eventData.eventType === 'hybrid') {
                eventData.tickets.venue.price = 0;
                eventData.tickets.online.price = 0;
            }
        }

        // Update or create event in Firebase
        if (isEditing) {
            await updateDoc(doc(db, 'events', editingEventId), eventData);
            alert('Event updated successfully!');
        } else {
            await addDoc(collection(db, 'events'), eventData);
            alert('Event created successfully!');
        }

        // Reset form and view
        clearEventForm();
        toggleEventsView('view');
        loadEvents();

    } catch (error) {
        console.error('Error handling event:', error);
        alert(`Error ${isEditing ? 'updating' : 'creating'} event: ${error.message}`);
    }
}
        
        // Update clearEventForm to reset editing state
        function clearEventForm() {
            document.getElementById('eventName').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('bookingStartDate').value = '';
            document.getElementById('bookingDeadline').value = '';
            document.getElementById('eventPrice').value = '';
            document.getElementById('eventTickets').value = '';
            
            const imageContainer = document.getElementById('imageUrlsContainer');
            imageContainer.innerHTML = `
                <div class="form-group image-input">
                    <label>Image URL #1</label>
                    <input type="text" class="eventImage" placeholder="Enter image URL">
                    <button type="button" onclick="addImageField()" class="add-image-btn">+ Add Another Image</button>
                </div>
            `;
            imageFieldCount = 1;
    
            const cancelBtn = document.querySelector('.cancel-btn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
            
            const createBtn = document.querySelector('.create-btn');
            if (createBtn) {
                createBtn.textContent = 'Create Event';
            }
            
            // Clear description and rules directly
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventRules').innerHTML = '';
            
            const eventTypeSelect = document.getElementById('eventType');
            eventTypeSelect.value = '';
            handleEventTypeChange();
            
            document.querySelector('.event-form').scrollIntoView({ behavior: 'smooth' });
        }
    
        async function loadEvents() {
            try {
                console.log("Starting to load events...");
                const eventList = document.getElementById('eventList');
                if (!eventList) {
                    console.error("Event list element not found");
                    return;
                }
    
                eventList.innerHTML = '<p>Loading events...</p>';
                const eventsRef = collection(db, 'events');
                
                console.log("Fetching events...");
                const snapshot = await getDocs(eventsRef);
                
                console.log("Events fetched:", snapshot.size);
                eventList.innerHTML = '';
    
                if (snapshot.empty) {
                    console.log("No events found");
                    eventList.innerHTML = '<p>No events found. Create your first event!</p>';
                    return;
                }
    
                snapshot.forEach((doc) => {
                    console.log("Processing event:", doc.id);
                    const event = doc.data();
                    const eventCard = createEventCard(event, doc.id);
                    eventList.appendChild(eventCard);
                });
    
            } catch (error) {
                console.error("Detailed error loading events:", error);
                const eventList = document.getElementById('eventList');
                if (eventList) {
                    eventList.innerHTML = `
                        <div class="error-message">
                            <p>Error loading events. Please try again.</p>
                            <button onclick="loadEvents()" class="retry-btn">Retry</button>
                        </div>
                    `;
                }
            }
        }
    
        // Helper function to create event cards
        function createEventCard(event, eventId) {
            try {
                const div = document.createElement('div');
                div.className = 'event-card';
                div.setAttribute('data-event-id', eventId);

                // Determine event visibility status
                const now = new Date();
                let visibilityStatus = '';
                
                if (event.scheduling) {
                    if (event.scheduling.hideDate && new Date(event.scheduling.hideDate) < now) {
                        visibilityStatus = `
                            <span class="visibility-status archived">
                                <i class="fas fa-archive"></i>
                                Archived
                            </span>
                        `;
                    } else if (event.scheduling.publishDate && new Date(event.scheduling.publishDate) > now) {
                        visibilityStatus = `
                            <span class="visibility-status scheduled">
                                <i class="fas fa-clock"></i>
                                Scheduled
                            </span>
                        `;
                    } else {
                        visibilityStatus = `
                            <span class="visibility-status published">
                                <i class="fas fa-globe"></i>
                                Published
                            </span>
                        `;
                    }
                } else {
                    visibilityStatus = `
                        <span class="visibility-status published">
                            <i class="fas fa-globe"></i>
                            Published
                        </span>
                    `;
                }

                const eventTypeBadge = `
                    <span class="event-type-badge ${event.eventType}">
                        ${event.eventType ? event.eventType.charAt(0).toUpperCase() + event.eventType.slice(1) : 'Unknown'}
                    </span>
                `;
    
                const ticketInfoHTML = event.eventType === 'hybrid' ? `
                    <div class="ticket-type-info">
                        <h4>Ticket Information</h4>
                        <div class="venue-tickets">
                            <strong>Venue Tickets:</strong>
                            <p>Available: ${event.tickets?.venue?.available || 0}/${event.tickets?.venue?.total || 0}</p>
                            <p>Price: â‚¹${event.tickets?.venue?.price?.toFixed(2) || '0.00'}</p>
                        </div>
                        <div class="online-tickets">
                            <strong>Online Tickets:</strong>
                            <p>Available: ${event.tickets?.online?.available || 0}/${event.tickets?.online?.total || 0}</p>
                            <p>Price: â‚¹${event.tickets?.online?.price?.toFixed(2) || '0.00'}</p>
                        </div>
                    </div>
                ` : `
                    <div class="ticket-type-info">
                        <h4>Ticket Information</h4>
                        <p>Available Tickets: ${event.availableTickets || 0}/${event.totalTickets || 0}</p>
                        <p>Price: â‚¹${event.price?.toFixed(2) || '0.00'}</p>
                    </div>
                `;
    
                const onlineDetailsHTML = (event.eventType === 'online' || event.eventType === 'hybrid') && event.onlineDetails ? `
                    <div class="event-details-section">
                        <h4>Online Event Details</h4>
                        <p><strong>Platform:</strong> ${event.onlineDetails.platform || 'Not specified'}</p>
                        <p class="secured-info">Meeting link and access details will be shared after booking</p>
                    </div>
                ` : '';
    
                const venueDetailsHTML = (event.eventType === 'venue' || event.eventType === 'hybrid') && event.venueDetails ? `
                    <div class="event-details-section">
                        <h4>Venue Details</h4>
                        <p><strong>Location:</strong> ${event.venueDetails.place || 'Not specified'}</p>
                        <p><strong>Venue:</strong> ${event.venueDetails.venue || 'Not specified'}</p>
                    </div>
                ` : '';
    
                const bookingStatus = getBookingStatus(event);
                const bookingStatusHTML = `
                    <div class="booking-status ${bookingStatus.status}">
                        ${bookingStatus.message}
                    </div>
                `;
    
                const imagesHTML = event.images && Array.isArray(event.images) ? `
                    <div class="event-images">
                        ${event.images.map(img => `<img src="${img}" alt="Event image" onerror="this.src='placeholder.jpg'">`).join('')}
                    </div>
                ` : '';
    
                const descriptionHTML = `
                    <div class="event-description-section">
                        <h4>About This Event</h4>
                        <div class="formatted-description">
                            ${event.description || 'No description available'}
                        </div>
                    </div>
                `;
    
                const rulesHTML = event.rules ? `
                    <div class="event-details-section">
                        <h4>Event Rules</h4>
                        <div class="formatted-content">
                            ${event.rules}
                        </div>
                    </div>
                ` : '';
    
                const limitationsHTML = event.limitations ? `
                    <div class="event-details-section">
                        <h4>Event Limitations</h4>
                        <div class="formatted-content">
                            ${event.limitations}
                        </div>
                    </div>
                ` : '';
    
                div.innerHTML = `
                    <div class="event-card-content">
                        <div class="event-header">
                            <h3>
                                ${event.name || 'Unnamed Event'} 
                                ${eventTypeBadge}
                                ${visibilityStatus}
                            </h3>
                            <div class="event-id">ID: ${event.eventId || eventId}</div>
                        </div>
    
                        ${imagesHTML}
                        
                        <div class="event-info">
                            <div class="event-meta">
                                <p><strong>Event Date:</strong> ${new Date(event.date).toLocaleString()}</p>
                                <p><strong>Booking Period:</strong> 
                                    ${new Date(event.bookingStartDate).toLocaleString()} - 
                                    ${new Date(event.bookingDeadline).toLocaleString()}
                                </p>
                            </div>
    
                            ${descriptionHTML}
                            ${rulesHTML}
                            ${limitationsHTML}
                            ${ticketInfoHTML}
                            ${onlineDetailsHTML}
                            ${venueDetailsHTML}
                        </div>
    
                        ${bookingStatusHTML}
                        
                        <div class="button-group">
                            <button onclick="handleEditClick('${eventId}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" class="edit-btn">Edit</button>
                            <button onclick="deleteEvent('${eventId}')" class="delete-btn">Delete</button>
                        </div>
                    </div>
                `;
    
                return div;
    
            } catch (error) {
                console.error("Error creating event card:", error, event);
                const errorCard = document.createElement('div');
                errorCard.className = 'event-card error';
                errorCard.innerHTML = `
                    <div class="error-message">
                        <p>Error displaying this event</p>
                        <p class="error-details">${error.message}</p>
                    </div>
                `;
                return errorCard;
            }
        }
    
        // Updated getBookingStatus function
        function getBookingStatus(event) {
            try {
                const now = new Date();
                const bookingStartDate = new Date(event.bookingStartDate);
                const bookingDeadline = new Date(event.bookingDeadline);
                
                if (now < bookingStartDate) {
                    return {
                        status: 'not-started',
                        message: 'Booking Not Started Yet',
                        canBook: false
                    };
                }
                
                if (now > bookingDeadline) {
                    return {
                        status: 'closed',
                        message: 'Booking Closed',
                        canBook: false
                    };
                }
    
                if (event.eventType === 'hybrid') {
                    const venueAvailable = event.tickets?.venue?.available > 0;
                    const onlineAvailable = event.tickets?.online?.available > 0;
                    
                    if (!venueAvailable && !onlineAvailable) {
                        return {
                            status: 'sold-out',
                            message: 'All Tickets Sold Out',
                            canBook: false
                        };
                    }
                    
                    return {
                        status: 'active',
                        message: `Book Now (${venueAvailable ? 'Venue' : ''}${venueAvailable && onlineAvailable ? ' & ' : ''}${onlineAvailable ? 'Online' : ''} Available)`,
                        canBook: true,
                        venueAvailable,
                        onlineAvailable
                    };
                } else {
                    if (event.availableTickets <= 0) {
                        return {
                            status: 'sold-out',
                            message: 'Sold Out',
                            canBook: false
                        };
                    }
                    
                    return {
                        status: 'active',
                        message: 'Book Now',
                        canBook: true
                    };
                }
            } catch (error) {
                console.error("Error getting booking status:", error);
                return {
                    status: 'error',
                    message: 'Status Unavailable',
                    canBook: false
                };
            }
        }
    
        // Add this new function to handle edit button clicks
        function handleEditClick(eventId, eventData) {
            try {
                console.log("Edit clicked for event:", eventId);
                console.log("Event data:", eventData);
                
                // Set the editing flags
                isEditing = true;
                currentEditingEventId = eventId; // Make sure this is the document ID from Firestore
                
                toggleEventsView('create');
                openEditModal(eventId, eventData);
                
                // Update button text
                const createBtn = document.querySelector('.create-btn');
                if (createBtn) {
                    createBtn.textContent = 'Update Event';
                }
                
                // Show cancel button
                const cancelBtn = document.querySelector('.cancel-btn');
                if (cancelBtn) {
                    cancelBtn.style.display = 'block';
                }
                
                // Update toggle buttons
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.toggle-btn[onclick*="create"]').classList.add('active');
                
            } catch (error) {
                console.error("Error handling edit click:", error);
                alert("Error opening edit form: " + error.message);
            }
        }
    
        // Make the function available globally
        window.handleEditClick = handleEditClick;
    
        // Add this helper function for event status
        function getEventStatus(event) {
            const now = new Date();
            const startDate = new Date(event.bookingStartDate);
            const deadlineDate = new Date(event.bookingDeadline);
            const eventDate = new Date(event.date);
            
            if (now < startDate) {
                return '<span class="status-upcoming">Booking Not Started</span>';
            } else if (now > deadlineDate || now > eventDate) {
                return '<span class="status-closed">Booking Closed</span>';
            } else if (event.availableTickets <= 0) {
                return '<span class="status-sold-out">Sold Out</span>';
            } else {
                return '<span class="status-active">Booking Open</span>';
            }
        }
    
        // Make sure to initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded");
            const auth = getAuth();
            
            auth.onAuthStateChanged((user) => {
    if (!user) {
        // User is signed out, redirect to index
        localStorage.clear();
        sessionStorage.clear();
        const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
        window.location.replace(`${baseUrl}index.html`);
    } else if (!user.email.toLowerCase().includes('admin')) {
        // User is not an admin, redirect to regular dashboard
        localStorage.clear();
        sessionStorage.clear();
        const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
        window.location.replace(`${baseUrl}/dashboard.html`);
    }
});
        });
    
        // Update the deleteEvent function
        async function deleteEvent(eventId) {
            try {
                if (!confirm('Are you sure you want to delete this event? This will also delete all associated tickets.')) {
                    return;
                }

                // Show loading state
                const deleteBtn = document.querySelector(`button[onclick="deleteEvent('${eventId}')"]`);
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;

                // First, get all tickets associated with this event
                const ticketsRef = collection(db, 'tickets');
                const ticketQuery = query(ticketsRef, where('eventId', '==', eventId));
                const ticketSnapshot = await getDocs(ticketQuery);

                // Delete all associated tickets
                const ticketDeletions = ticketSnapshot.docs.map(doc => 
                    deleteDoc(doc.ref)
                );

                // Wait for all ticket deletions to complete
                await Promise.all(ticketDeletions);

                // Then delete the event
                await deleteDoc(doc(db, 'events', eventId));

                // Remove the event card from UI
                const eventCard = document.querySelector(`[data-event-id="${eventId}"]`);
                if (eventCard) {
                    eventCard.remove();
                }

                alert('Event and associated tickets have been deleted successfully');

            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Error deleting event: ' + error.message);
                
                // Restore delete button
                if (deleteBtn) {
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                }
            }
        }
    
        // Tickets function
        async function loadTickets() {
    try {
        // Get event selector element
        const eventSelector = document.getElementById('adminEventSelector');
        
        // Get all active events
        const eventsRef = collection(db, 'events');
        const eventsSnapshot = await getDocs(eventsRef);
        const activeEvents = {};
        
        // Clear existing options
        eventSelector.innerHTML = '<option value="">All Events</option>';
        
        // Populate events dropdown and activeEvents object
        eventsSnapshot.forEach(doc => {
            const event = doc.data();
            if (!event.deleted && event.status !== 'deleted') {
                activeEvents[doc.id] = event;
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = event.name;
                eventSelector.appendChild(option);
            }
        });

        // Initial load of all tickets with empty filters
        await filterTickets('', activeEvents, '');

        // Add event listeners for filtering
        document.getElementById('adminTicketSearch').addEventListener('input', async (e) => {
            await filterTickets(e.target.value, activeEvents, eventSelector.value);
        });

        eventSelector.addEventListener('change', async (e) => {
            await filterTickets(
                document.getElementById('adminTicketSearch').value,
                activeEvents,
                e.target.value
            );
        });

    } catch (error) {
        console.error("Error loading tickets:", error);
        alert("Error loading tickets: " + error.message);
    }
}
    
        // Add function to update stats display
        function updateTicketStats(totalTickets, totalSold, totalRevenue, totalUsed, availableTickets) {
    document.getElementById('adminTotalTickets').textContent = totalTickets;
    document.getElementById('adminSoldTickets').textContent = totalSold;
    document.getElementById('adminAvailableTickets').textContent = availableTickets;
    document.getElementById('adminUsedTickets').textContent = totalUsed;
    document.getElementById('adminTotalRevenue').textContent = formatCurrency(totalRevenue);
}
    
        // Add function to filter tickets
        async function filterTickets(searchTerm = '', activeEvents = {}, eventId = '') {
    try {
        const ticketsRef = collection(db, 'tickets');
        const ticketsSnapshot = await getDocs(ticketsRef);
        let filteredTickets = [];
        let totalTickets = 0;      // Will store total tickets from events
        let totalSold = 0;         // Will store total tickets sold
        let totalRevenue = 0;
        let totalUsed = 0;

        // First, calculate total tickets from events
        if (eventId) {
            // If specific event is selected
            const event = activeEvents[eventId];
            if (event) {
                if (event.eventType === 'hybrid') {
                    totalTickets = (event.tickets?.venue?.total || 0) + (event.tickets?.online?.total || 0);
                } else {
                    totalTickets = event.totalTickets || 0;
                }
            }
        } else {
            // If no specific event is selected, sum up all events
            Object.values(activeEvents).forEach(event => {
                if (event.eventType === 'hybrid') {
                    totalTickets += (event.tickets?.venue?.total || 0) + (event.tickets?.online?.total || 0);
                } else {
                    totalTickets += event.totalTickets || 0;
                }
            });
        }

        // Process tickets for sold and used counts
        ticketsSnapshot.forEach(doc => {
            const ticket = doc.data();
            const event = activeEvents[ticket.eventId];
            
            if (event) {
                const searchString = `
                    ${event.name || ''} 
                    ${ticket.eventId || ''} 
                    ${ticket.userEmail || ''} 
                    ${ticket.ticketIdentifier || ''}
                `.toLowerCase();
                
                const matchesSearch = !searchTerm || searchString.includes(searchTerm.toLowerCase());
                const matchesEvent = !eventId || ticket.eventId === eventId;
                
                if (matchesSearch && matchesEvent) {
                    filteredTickets.push({
                        id: doc.id,
                        ...ticket,
                        eventName: event.name
                    });
                    
                    if (ticket.paymentStatus === 'completed') {
                        const ticketCount = Number(ticket.ticketCount) || 1;
                        totalSold += ticketCount;
                        totalRevenue += Number(ticket.totalPrice) || 0;
                        
                        if (ticket.used) {
                            totalUsed += ticketCount;
                        }
                    }
                }
            }
        });

        // Calculate available tickets
        const availableTickets = totalTickets - totalSold;

        // Update stats display
        const statsElements = {
            totalTickets: document.getElementById('adminTotalTickets'),
            soldTickets: document.getElementById('adminSoldTickets'),
            availableTickets: document.getElementById('adminAvailableTickets'),
            usedTickets: document.getElementById('selectedEventUsedTickets'),
            revenue: document.getElementById('selectedEventTotalRevenue')
        };

        // Only update if elements exist
        if (statsElements.totalTickets) statsElements.totalTickets.textContent = totalTickets;
        if (statsElements.soldTickets) statsElements.soldTickets.textContent = totalSold;
        if (statsElements.availableTickets) statsElements.availableTickets.textContent = availableTickets;
        if (statsElements.usedTickets) statsElements.usedTickets.textContent = totalUsed;
        if (statsElements.revenue) statsElements.revenue.textContent = formatCurrency(totalRevenue);


        // Display filtered tickets
        const ticketList = document.getElementById('adminTicketList');
        if (ticketList) {
            if (filteredTickets.length === 0) {
                ticketList.innerHTML = '<p class="no-tickets">No tickets found</p>';
            } else {
                // Inside filterTickets function, update the ticket list HTML generation:
ticketList.innerHTML = filteredTickets.map(ticket => `
    <div class="admin-ticket-card">
        <div class="admin-ticket-info">
            <h3>${ticket.eventName}</h3>
            <p>Ticket ID: ${ticket.ticketIdentifier}</p>
            <p>User: ${ticket.userEmail}</p>
            <p>Quantity: ${ticket.ticketCount || 1}</p>
            <p>Status: ${ticket.used ? 'Used' : 'Not Used'}</p>
            <p>Payment: ${ticket.paymentStatus}</p>
            <p>Price: ${formatCurrency(ticket.totalPrice || 0)}</p>
        </div>
        <div class="admin-ticket-actions">
            <button onclick="showTicketDetails('${ticket.id}')" class="admin-view-btn">
                <i class="fas fa-eye"></i> View Details
            </button>
        </div>
    </div>
`).join('');
            }
        }

    } catch (error) {
        console.error("Error filtering tickets:", error);
    }
}
document.addEventListener('DOMContentLoaded', () => {
    const eventSelector = document.getElementById('adminEventSelector');
    const searchInput = document.getElementById('adminTicketSearch');

    if (eventSelector) {
        eventSelector.addEventListener('change', () => {
            const searchTerm = searchInput?.value || '';
            filterTickets(searchTerm, window.activeEvents || {}, eventSelector.value);
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const eventId = eventSelector?.value || '';
            filterTickets(searchInput.value, window.activeEvents || {}, eventId);
        });
    }
});
    
        // Add function to display tickets
        function displayTickets(tickets) {
    const ticketList = document.getElementById('adminTicketList');
    
    if (!ticketList) {
        console.error('Ticket list container not found');
        return;
    }

    if (tickets.length === 0) {
        ticketList.innerHTML = '<p class="no-tickets">No tickets found</p>';
        return;
    }

    let html = '';
    tickets.forEach(ticket => {
        const status = getTicketStatus(ticket);
        html += `
            <div class="admin-ticket-card">
                <div class="admin-ticket-info">
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Ticket ID</span>
                        <span class="admin-ticket-value">${ticket.ticketIdentifier}</span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Event</span>
                        <span class="admin-ticket-value">${ticket.eventName}</span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">User</span>
                        <span class="admin-ticket-value">${ticket.userEmail || 'N/A'}</span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Purchase Date</span>
                        <span class="admin-ticket-value">${new Date(ticket.purchaseDate).toLocaleString()}</span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Quantity</span>
                        <span class="admin-ticket-value">
                            <span class="admin-ticket-quantity">
                                <i class="fas fa-ticket-alt"></i> ${ticket.ticketCount || 1}
                            </span>
                        </span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Price</span>
                        <span class="admin-ticket-value">
                            â‚¹${ticket.totalPrice || 0}
                        </span>
                    </div>
                    <div class="admin-ticket-detail">
                        <span class="admin-ticket-label">Status</span>
                        <span class="admin-status-badge admin-status-${status.toLowerCase()}">${status}</span>
                    </div>
                </div>
                <div class="admin-ticket-actions">
                    <button onclick="showTicketDetails('${ticket.id}')" class="admin-view-btn">
                        View Details
                    </button>
                </div>
            </div>
        `;
    });

    ticketList.innerHTML = html;
}
    
        // Add function to get ticket status
        function getTicketStatus(ticket) {
            const now = new Date();
            const eventDate = new Date(ticket.eventDate);
            
            if (ticket.used) {
                return 'Used';
            } else if (eventDate < now) {
                return 'Expired';
            } else if (eventDate.toDateString() === now.toDateString()) {
                return 'Active';
            } else {
                return 'Upcoming';
            }
        }
    
        // Update the showTicketDetails function
        async function showTicketDetails(ticketId) {
            try {
                const ticketDoc = await getDoc(doc(db, 'tickets', ticketId));
                if (!ticketDoc.exists()) {
                    throw new Error('Ticket not found');
                }
    
                const ticket = ticketDoc.data();
                
                const eventDoc = await getDoc(doc(db, 'events', ticket.eventId));
                const event = eventDoc.exists() ? eventDoc.data() : null;
                
                const quantity = ticket.ticketCount || 1;
                const unitPrice = (ticket.totalPrice || 0) / quantity;
    
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${ticket.ticketIdentifier || ticketIdentifier}`;
    
                const modalHtml = `
                    <div class="admin-ticket-modal">
                        <div class="admin-ticket-modal-content">
                            <div class="admin-ticket-modal-header">
                                <h2>Ticket Details</h2>
                                <span class="admin-close-modal">&times;</span>
                            </div>
                            
                            <div class="admin-ticket-details-card">
                                <div class="admin-ticket-header">
                                    <div class="admin-ticket-title">
                                        <h3>${event?.name || 'Event'}</h3>
                                        <span class="admin-ticket-type">${ticket.ticketType || 'Standard'}</span>
                                    </div>
                                    <div class="admin-ticket-persons">
                                        <i class="fas fa-users"></i> ${quantity} Person${quantity > 1 ? 's' : ''}
                                    </div>
                                </div>
    
                                <div class="admin-ticket-grid">
                                    <div class="admin-detail-group">
                                        <label>Ticket ID</label>
                                        <span>${ticket.ticketIdentifier || ticketIdentifier}</span>
                                    </div>
                                    <div class="admin-detail-group">
                                        <label>Purchaser Email</label>
                                        <span>${ticket.userEmail || 'N/A'}</span>
                                    </div>
                                    <div class="admin-detail-group">
                                        <label>Purchase Date</label>
                                        <span>${new Date(ticket.purchaseDate).toLocaleString()}</span>
                                    </div>
                                    <div class="admin-detail-group">
                                        <label>Event Date</label>
                                        <span>${event ? new Date(event.date).toLocaleString() : 'N/A'}</span>
                                    </div>
                                    <div class="admin-detail-group">
                                        <label>Total Price</label>
                                        <span class="admin-price">
                                            â‚¹${ticket.totalPrice || 0}
                                            <small>(â‚¹${unitPrice.toFixed(2)} Ã— ${quantity})</small>
                                        </span>
                                    </div>
                                    <div class="admin-detail-group">
                                        <label>Status</label>
                                        <span class="admin-status-badge admin-status-${getTicketStatus(ticket).toLowerCase()}">
                                            ${getTicketStatus(ticket)}
                                        </span>
                                    </div>
                                </div>
    
                                <div class="admin-ticket-qr-section">
                                    <div class="admin-qr-code">
                                        <img src="${qrCodeUrl}" alt="Ticket QR Code" class="admin-ticket-qr">
                                        <div class="admin-qr-id">ID: ${ticket.ticketIdentifier || ticketIdentifier}</div>
                                    </div>
                                </div>
    
                                ${event?.eventType === 'venue' || event?.eventType === 'hybrid' ? `
                                    <div class="admin-venue-details">
                                        <h4>Venue Information</h4>
                                        <div class="admin-detail-group">
                                            <label>Venue</label>
                                            <span>${event?.venueDetails?.venue || 'N/A'}</span>
                                        </div>
                                        <div class="admin-detail-group">
                                            <label>Location</label>
                                            <span>${event?.venueDetails?.place || 'N/A'}</span>
                                        </div>
                                    </div>
                                ` : ''}
    
                                ${event?.eventType === 'online' || event?.eventType === 'hybrid' ? `
                                    <div class="admin-online-details">
                                        <h4>Online Access</h4>
                                        <div class="admin-detail-group">
                                            <label>Platform</label>
                                            <span>${event?.onlineDetails?.platform || 'N/A'}</span>
                                        </div>
                                        <div class="admin-detail-group secured-info">
                                            <label>Access Details</label>
                                            <span>Will be shared before the event</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
    
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
    
                const closeBtn = modalContainer.querySelector('.admin-close-modal');
                closeBtn.onclick = () => modalContainer.remove();
    
                modalContainer.querySelector('.admin-ticket-modal').onclick = (e) => {
                    if (e.target === modalContainer.querySelector('.admin-ticket-modal')) {
                        modalContainer.remove();
                    }
                };
    
            } catch (error) {
                console.error("Error showing ticket details:", error);
                alert("Error loading ticket details: " + error.message);
            }
        }
    
        // Function to download ticket as PNG
        async function downloadTicket() {
            try {
                const ticketCard = document.getElementById('ticketCard');
                const canvas = await html2canvas(ticketCard, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                const link = document.createElement('a');
                link.download = 'event-ticket.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error("Error downloading ticket:", error);
                alert("Error downloading ticket. Please try again.");
            }
        }
    
        // Make functions globally available
        window.showTicketDetails = showTicketDetails;
        window.downloadTicket = downloadTicket;
    
        // Make getDoc available globally
        window.getDoc = getDoc;
    
        // Make functions globally available
        window.showSection = showSection;
        window.handleCreateEvent = handleCreateEvent;
        window.deleteEvent = deleteEvent;
        window.logout = handleLogout;
        window.addImageField = addImageField;
        window.removeImageField = removeImageField;
        window.loadDashboard = loadDashboard;
        window.loadEvents = loadEvents;
        window.loadTickets = loadTickets;
    
        // Make sure to call these functions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadEvents();
            loadTickets();
        });
    
        // Add real-time updates for events
        function initializeRealTimeListeners() {
            const eventsRef = collection(db, 'events');
            const eventsQuery = query(eventsRef, orderBy('createdAt', 'desc'));
    
            const unsubscribe = onSnapshot(eventsQuery, (snapshot) => {
                const eventList = document.getElementById('eventList');
                eventList.innerHTML = '';
    
                if (snapshot.empty) {
                    eventList.innerHTML = '<p>No events found</p>';
                    return;
                }
    
                snapshot.forEach((doc) => {
                    const event = doc.data();
                    const eventCard = createEventCard(event, doc.id);
                    eventList.appendChild(eventCard);
                });
            }, (error) => {
                console.error("Error in real-time updates:", error);
            });
    
            window.addEventListener('beforeunload', unsubscribe);
        }
    
        // Make functions globally available
        window.openEditModal = openEditModal;
        window.handleCreateEvent = handleCreateEvent;
        window.clearEventForm = clearEventForm;
        window.initializeRealTimeListeners = initializeRealTimeListeners;
    
        // Initialize real-time updates when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeRealTimeListeners();
        });
    
        // Add this after your Firebase initialization
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("Logged in user:", user.email);
                console.log("User ID:", user.uid);
            } else {
                console.log("No user logged in");
            }
        });
    
        // Add this logging code
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("Current user:", {
                    email: user.email,
                    uid: user.uid,
                    emailVerified: user.emailVerified
                });
            } else {
                console.log("No user logged in");
            }
        });
    
        // Add this CSS for better statistics display
    
        document.head.appendChild(style);
    
        // Make sure to call loadDashboard when needed
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    
        // Add real-time updates for dashboard
            // Get references to Firebase collections
    const eventsRef = collection(db, 'events');
    const ticketsRef = collection(db, 'tickets');

    // Listen for ticket changes
    onSnapshot(ticketsRef, async (snapshot) => {
        if (document.getElementById('dashboard').style.display === 'block') {
            await loadDashboard();
        }
    });

    // Listen for event changes
    onSnapshot(eventsRef, async (snapshot) => {
        if (document.getElementById('dashboard').style.display === 'block') {
            await loadDashboard();
        }
    });

    
        // Make functions globally available
        window.loadDashboard = loadDashboard;
        window.initializeDashboardListeners = initializeDashboardListeners;
    
        // Initialize dashboard listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboardListeners();
        });
    
        // Add these functions to your existing JavaScript
        let allEvents = [];
        let currentFilter = 'all';
    
        // Function to generate unique event ID
        function generateEventId() {
            const timestamp = new Date().getTime().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 7);
            return `EVT-${timestamp}-${randomStr}`.toUpperCase();
        }
    
        // Load all events initially
        async function loadFilteredEvents() {
            try {
                const eventsSnapshot = await getDocs(collection(db, 'events'));
                allEvents = [];
                
                eventsSnapshot.forEach(doc => {
                    allEvents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                applyFilters('all');
            } catch (error) {
                console.error("Error loading events:", error);
                document.getElementById('filteredEventsList').innerHTML = `
                    <div class="error-message">
                        Error loading events. Please try again.
                        <button onclick="loadFilteredEvents()" class="retry-btn">Retry</button>
                    </div>
                `;
            }
        }
    
        // Apply filters to events
        function applyFilters(filterType = currentFilter) {
            currentFilter = filterType;
    
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(filterType.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
    
            const searchTerm = document.getElementById('eventSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('eventDateFilter').value;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
            let filteredEvents = allEvents.filter(event => {
                const eventDate = new Date(event.date);
                const eventName = (event.name || '').toLowerCase();
                const eventId = (event.eventId || '').toLowerCase();
                
                if (searchTerm && !eventName.includes(searchTerm) && !eventId.includes(searchTerm)) {
                    return false;
                }
    
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const eventDateOnly = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                    if (eventDateOnly.getTime() !== filterDate.getTime()) {
                        return false;
                    }
                }
    
                switch (filterType) {
                    case 'upcoming':
                        return eventDate > now;
                    case 'today':
                        return eventDate.getDate() === today.getDate() &&
                               eventDate.getMonth() === today.getMonth() &&
                               eventDate.getFullYear() === today.getFullYear();
                    case 'past':
                        return eventDate < now;
                    default:
                        return true;
                }
            });
    
            filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
    
            displayFilteredEvents(filteredEvents);
        }
    
        // Display filtered events
        function displayFilteredEvents(events) {
            const container = document.getElementById('filteredEventsList');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="no-events-message">
                        <p>No events found matching your criteria.</p>
                    </div>
                `;
                return;
            }
    
            let html = `
                <div class="events-grid">
                    ${events.map(event => `
                        <div class="event-card">
                            <div class="event-header">
                                <div>
                                    <h3>${event.name || 'Unnamed Event'}</h3>
                                    <div class="event-id">ID: ${event.eventId || 'No ID'}</div>
                                </div>
                                ${getEventStatusBadge(event)}
                            </div>
                            <div class="event-details">
                                <p><strong>Date:</strong> ${new Date(event.date).toLocaleString()}</p>
                                <p><strong>Location:</strong> ${event.place || 'Not specified'}</p>
                                <p><strong>Venue:</strong> ${event.venue || 'Not specified'}</p>
                                <p><strong>Price:</strong> â‚¹${(event.price || 0).toFixed(2)}</p>
                                <p><strong>Available Tickets:</strong> ${event.availableTickets || 0}/${event.totalTickets || 0}</p>
                            </div>
                            <div class="event-actions">
                                <button onclick="handleEditClick('${event.id}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" class="edit-btn">Edit</button>
                                <button onclick="deleteEvent('${event.id}')" class="delete-btn">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
    
        // Get event status badge
        function getEventStatusBadge(event) {
            const eventDate = new Date(event.date);
            const now = new Date();
    
            if (eventDate < now) {
                return '<span class="status-badge past">Past</span>';
            } else if (event.availableTickets <= 0) {
                return '<span class="status-badge sold-out">Sold Out</span>';
            } else {
                return '<span class="status-badge upcoming">Upcoming</span>';
            }
        }
    
        // Make functions globally available
        window.generateEventId = generateEventId;
        window.loadFilteredEvents = loadFilteredEvents;
        window.applyFilters = applyFilters;
        window.showSection = showSection;
    
        function handleEventTypeChange() {
            const eventType = document.getElementById('eventType').value;
            const onlineDetails = document.getElementById('onlineEventDetails');
            const venueDetails = document.getElementById('venueEventDetails');
            const ticketingSection = document.getElementById('ticketingSection');
            const standardTicketsSection = document.getElementById('standardTicketsSection');
            const hybridTicketsSection = document.getElementById('hybridTicketsSection');
            const priceField = document.getElementById('eventPrice').parentElement;
    
            onlineDetails.style.display = 'none';
            venueDetails.style.display = 'none';
            ticketingSection.style.display = 'none';
            standardTicketsSection.style.display = 'none';
            hybridTicketsSection.style.display = 'none';
            priceField.style.display = 'block';
    
            switch (eventType) {
                case 'online':
                    onlineDetails.style.display = 'block';
                    ticketingSection.style.display = 'block';
                    standardTicketsSection.style.display = 'block';
                    break;
                case 'venue':
                    venueDetails.style.display = 'block';
                    ticketingSection.style.display = 'block';
                    standardTicketsSection.style.display = 'block';
                    break;
                case 'hybrid':
                    onlineDetails.style.display = 'block';
                    venueDetails.style.display = 'block';
                    ticketingSection.style.display = 'block';
                    hybridTicketsSection.style.display = 'block';
                    priceField.style.display = 'none';
                    break;
            }
        }
    
        // Add validation for dates
        function validateEventDates() {
            const eventDate = new Date(document.getElementById('eventDate').value);
            const bookingStartDate = new Date(document.getElementById('bookingStartDate').value);
            const bookingDeadline = new Date(document.getElementById('bookingDeadline').value);
            const now = new Date();
    
            document.getElementById('eventDate').min = now.toISOString().slice(0, 16);
    
            if (eventDate < now) {
                alert('Event date must be in the future');
                return false;
            }
    
            if (bookingStartDate > eventDate) {
                alert('Booking start date must be before event date');
                return false;
            }
    
            if (bookingDeadline > eventDate) {
                alert('Booking deadline must be before or same as event date');
                return false;
            }
    
            if (bookingDeadline < bookingStartDate) {
                alert('Booking deadline must be after booking start date');
                return false;
            }
    
            return true;
        }
    
        // Add validation for tickets
        function validateTickets() {
            const eventType = document.getElementById('eventType').value;
            let isValid = true;
    
            if (eventType === 'hybrid') {
                const venueTickets = parseInt(document.getElementById('venueTickets').value) || 0;
                const onlineTickets = parseInt(document.getElementById('onlineTickets').value) || 0;
                const venuePrice = parseFloat(document.getElementById('venueTicketPrice').value) || 0;
                const onlinePrice = parseFloat(document.getElementById('onlineTicketPrice').value) || 0;
                
                if (venueTickets <= 0 && onlineTickets <= 0) {
                    alert('Please specify ticket capacity for at least one ticket type');
                    isValid = false;
                }
    
                if (venueTickets > 0 && venuePrice <= 0) {
                    alert('Please specify a valid price for venue tickets');
                    isValid = false;
                }
    
                if (onlineTickets > 0 && onlinePrice <= 0) {
                    alert('Please specify a valid price for online tickets');
                    isValid = false;
                }
            } else {
                const totalTickets = parseInt(document.getElementById('eventTickets').value) || 0;
                const price = parseFloat(document.getElementById('eventPrice').value) || 0;
                
                if (totalTickets <= 0) {
                    alert('Total tickets must be greater than 0');
                    isValid = false;
                }
    
                if (price <= 0) {
                    alert('Please specify a valid ticket price');
                    isValid = false;
                }
            }
    
            return isValid;
        }
    
        function cancelEdit() {
            try {
                clearEventForm();
                
                toggleEventsView('view');
                
                isEditing = false;
                currentEditingEventId = null;
                
                const editors = ['eventDescription', 'eventRules', 'eventLimitations'];
                editors.forEach(editorId => {
                    const editor = tinymce.get(editorId);
                    if (editor) {
                        editor.setContent('');
                    }
                });
                
            } catch (error) {
                console.error("Error canceling edit:", error);
                alert("Error canceling edit. Please try again.");
            }
        }
    
        // Add to your existing global assignments
        window.cancelEdit = cancelEdit;
    
        // Update the switchVerificationMethod function
        function switchVerificationMethod(method) {
            if (window.html5QrcodeScanner) {
                window.html5QrcodeScanner.clear();
                window.html5QrcodeScanner = null;
            }
    
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[onclick="window.switchVerificationMethod('${method}')"]`).classList.add('active');
    
            document.querySelectorAll('.verification-method').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById(`${method}Verification`).style.display = 'block';
    
            if (method === 'qr') {
                window.initQRScanner();
                document.querySelector('.scan-btn').style.display = 'block';
                document.querySelector('[onclick="window.stopQRScanner()"]').style.display = 'none';
            }
        }
    
        window.showVerificationResult = function(result) {
            const resultDiv = document.getElementById('verificationResult');
            const statusSpan = resultDiv.querySelector('.result-status');
            const detailsDiv = resultDiv.querySelector('.ticket-details');
            const markUsedBtn = resultDiv.querySelector('.mark-used-btn');
    
            statusSpan.className = 'result-status ' + result.status;
            statusSpan.textContent = result.message;
    
            if (result.ticket && result.event) {
                detailsDiv.innerHTML = `
                    <h4>Ticket Information</h4>
                    <p><strong>Ticket ID:</strong> ${result.ticket.ticketId}</p>
                    <p><strong>Event:</strong> ${result.event.name}</p>
                    <p><strong>Event Date:</strong> ${new Date(result.event.date).toLocaleString()}</p>
                    <p><strong>Ticket Type:</strong> ${result.ticket.ticketType || 'Standard'}</p>
                    <p><strong>Purchase Date:</strong> ${new Date(result.ticket.purchaseDate).toLocaleString()}</p>
                    <p><strong>Purchased By:</strong> ${result.ticket.userEmail}</p>
                `;
                markUsedBtn.style.display = result.status === 'valid' ? 'block' : 'none';
            } else {
                detailsDiv.innerHTML = '';
                markUsedBtn.style.display = 'none';
            }
    
            resultDiv.style.display = 'block';
        };
    
        window.switchVerificationMethod = async function(method) {
            try {
                if (window.html5QrcodeScanner) {
                    await window.html5QrcodeScanner.stop();
                    window.html5QrcodeScanner = null;
                }
    
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.tab-btn[onclick="window.switchVerificationMethod('${method}')"]`).classList.add('active');
    
                document.querySelectorAll('.verification-method').forEach(el => {
                    el.style.display = 'none';
                });
                document.getElementById(`${method}Verification`).style.display = 'block';
    
                if (method === 'qr') {
                    await window.initQRScanner();
                    document.querySelector('.scan-btn').style.display = 'block';
                    document.querySelector('[onclick="window.stopQRScanner()"]').style.display = 'none';
                }
            } catch (error) {
                console.error("Error switching verification method:", error);
                alert("Error: " + error.message);
            }
        };
    
        if (typeof Html5QrCode === 'undefined') {
            console.error('HTML5QrCode library not loaded. Please check the script inclusion.');
        }
    
        function toggleEventsView(view) {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.toggle-btn[onclick*="${view}"]`).classList.add('active');
    
            const createSection = document.getElementById('createEventSection');
            const viewSection = document.getElementById('viewEventSection');
    
            if (view === 'create') {
                createSection.style.display = 'block';
                viewSection.style.display = 'none';
            } else {
                createSection.style.display = 'none';
                viewSection.style.display = 'block';
                loadEvents();
            }
        }
    
        function filterEvents() {
            const searchTerm = document.getElementById('eventSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('eventTypeFilter').value;
            const statusFilter = document.getElementById('eventStatusFilter').value;
            const eventList = document.getElementById('eventList');
            const eventCards = eventList.querySelectorAll('.event-card');
            const now = new Date();
    
            eventCards.forEach(card => {
                let showCard = true;
    
                const eventName = card.querySelector('h3').textContent.toLowerCase();
                const eventId = card.querySelector('.event-id').textContent.toLowerCase();
                const eventType = card.querySelector('.event-type-badge')?.textContent.toLowerCase() || '';
                const eventDateText = card.querySelector('.event-meta p:first-child')?.textContent;
                const eventDate = eventDateText ? new Date(eventDateText.split(': ')[1]) : now;
    
                if (searchTerm && !eventName.includes(searchTerm) && !eventId.includes(searchTerm)) {
                    showCard = false;
                }
    
                if (typeFilter && !eventType.includes(typeFilter.toLowerCase())) {
                    showCard = false;
                }
    
                if (statusFilter) {
                    const eventTime = eventDate.getTime();
                    const nowTime = now.getTime();
                    const oneDayMs = 24 * 60 * 60 * 1000;
    
                    switch (statusFilter) {
                        case 'upcoming':
                            if (eventTime <= nowTime) showCard = false;
                            break;
                        case 'ongoing':
                            if (eventTime < nowTime || eventTime > (nowTime + oneDayMs)) showCard = false;
                            break;
                        case 'completed':
                            if (eventTime > nowTime) showCard = false;
                            break;
                    }
                }
    
                card.style.display = showCard ? '' : 'none';
            });
        }
    
        // Make functions globally available
        window.toggleEventsView = toggleEventsView;
        window.filterEvents = filterEvents;
    
        // Add this function for PNG download
        function downloadTicketPNG(ticketId) {
            try {
                const ticketCard = document.getElementById('ticketCard');
                if (!ticketCard) {
                    throw new Error('Ticket card element not found');
                }
    
                html2canvas(ticketCard).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ticket-${ticketId}.png`;
                    link.href = canvas.toDataURL('image/png');
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
    
            } catch (error) {
                console.error("Error downloading ticket:", error);
                alert("Error downloading ticket: " + error.message);
            }
        }
    
        // Update the button in showTicketDetails function
        // Replace the download button HTML with this:
        `<div class="admin-ticket-actions">
            <button onclick="downloadTicketPNG('${ticketId}')" class="admin-download-btn">
                <i class="fas fa-download"></i> Download Ticket (PNG)
            </button>
        </div>`

        // Update the verification function
        async function verifyTicket(ticketId) {
            try {
                // Query tickets collection using ticketIdentifier
                const ticketsRef = collection(db, 'tickets');
                const q = query(ticketsRef, where('ticketIdentifier', '==', ticketId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return {
                        status: 'invalid',
                        message: 'Invalid Ticket',
                        ticket: null,
                        event: null
                    };
                }

                const ticketDoc = querySnapshot.docs[0];
                const ticket = ticketDoc.data();

                // Get event details
                const eventDoc = await getDoc(doc(db, 'events', ticket.eventId));
                if (!eventDoc.exists()) {
                    return {
                        status: 'invalid',
                        message: 'Event not found',
                        ticket,
                        event: null
                    };
                }

                const event = eventDoc.data();
                const now = new Date();
                const eventDate = new Date(event.date);

                if (ticket.used) {
                    return {
                        status: 'used',
                        message: 'Ticket already used',
                        ticket,
                        event
                    };
                }

                if (eventDate < now) {
                    return {
                        status: 'expired',
                        message: 'Event has ended',
                        ticket,
                        event
                    };
                }

                return {
                    status: 'valid',
                    message: 'Valid Ticket',
                    ticket,
                    event
                };
            } catch (error) {
                console.error("Error verifying ticket:", error);
                return {
                    status: 'error',
                    message: 'Error verifying ticket',
                    ticket: null,
                    event: null
                };
            }
        }

        // Update the mark ticket as used function
        async function markTicketAsUsed() {
            try {
                const ticketId = document.querySelector('.ticket-details p:first-child strong').nextSibling.textContent.trim();
                
                // Query to find the ticket document using ticketIdentifier
                const ticketsRef = collection(db, 'tickets');
                const q = query(ticketsRef, where('ticketIdentifier', '==', ticketId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const ticketDoc = querySnapshot.docs[0];
                    await updateDoc(ticketDoc.ref, {
                        used: true,
                        usedDate: new Date().toISOString()
                    });

                    alert('Ticket marked as used successfully!');
                    document.getElementById('verificationResult').style.display = 'none';
                } else {
                    throw new Error('Ticket not found');
                }
            } catch (error) {
                console.error("Error marking ticket as used:", error);
                alert('Error marking ticket as used: ' + error.message);
            }
        }

        // Add these functions to handle image management
        function handleImageUpload(event) {
            const files = event.target.files;
            const imageGrid = document.getElementById('imageGrid');
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <img src="${e.target.result}" alt="Event image">
                        <div class="image-actions">
                            <button class="image-action-btn" onclick="moveImage(this, 'up')" title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="image-action-btn" onclick="moveImage(this, 'down')" title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="image-action-btn delete" onclick="deleteImage(this)" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    imageGrid.appendChild(imageItem);
                };
                reader.readAsDataURL(file);
            });
        }

        function moveImage(button, direction) {
            const imageItem = button.closest('.image-item');
            const grid = imageItem.parentElement;
            
            if (direction === 'up' && imageItem.previousElementSibling) {
                grid.insertBefore(imageItem, imageItem.previousElementSibling);
            } else if (direction === 'down' && imageItem.nextElementSibling) {
                grid.insertBefore(imageItem.nextElementSibling, imageItem);
            }
        }

        function deleteImage(button) {
            if (confirm('Are you sure you want to delete this image?')) {
                button.closest('.image-item').remove();
            }
        }

        // Add event listener for image upload
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
    </script>
    
    <!-- Add this modal HTML just before closing body tag -->
    <div id="editEventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Event</h2>
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" id="editEventName" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editEventDescription" required></textarea>
            </div>
            <div class="form-group">
                <label>Event Date</label>
                <input type="datetime-local" id="editEventDate" required>
            </div>
            <div class="form-group">
                <label>Booking Start Date</label>
                <input type="datetime-local" id="editBookingStartDate" required>
            </div>
            <div class="form-group">
                <label>Booking Deadline</label>
                <input type="datetime-local" id="editBookingDeadline" required>
            </div>
            <div class="form-group">
                <label>Price (â‚¹)</label>
                <input type="number" id="editEventPrice" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Total Tickets</label>
                <input type="number" id="editEventTickets" required min="1">
            </div>
            <div id="editImageUrlsContainer">
                <!-- Image inputs will be added here -->
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <button type="button" onclick="updateEvent()" class="edit-btn">Update Event</button>
                <button type="button" onclick="cancelEdit()" class="cancel-btn" style="display: none;">Cancel Edit</button>
            </div>
        </div>
    </div>
    
    <script>
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            document.getElementById('userEmail').textContent = user.email;
        } else {
            console.log('User is signed out');
            window.location.href = 'login.html';
        }
    });
    </script>
    
    <script>
    async function loadRecentEvents() {
        try {
            const eventsRef = collection(db, 'events');
            const recentEventsQuery = query(eventsRef, orderBy('createdAt', 'desc'), limit(5));
            const recentEventsSnapshot = await getDocs(recentEventsQuery);
    
            const recentEventsList = document.getElementById('recentEventsList');
            recentEventsList.innerHTML = '';
    
            for (const eventDoc of recentEventsSnapshot.docs) {
                const event = eventDoc.data();
                const eventDate = new Date(event.date).toLocaleDateString();
                const eventStatus = getEventStatus(event);
                
                const eventItem = document.createElement('div');
                eventItem.className = 'recent-item';
                eventItem.innerHTML = `
                    <div class="recent-item-title">${event.name}</div>
                    <div class="recent-item-details">
                        <span>${eventDate}</span>
                        <span>${event.eventType}</span>
                        <span>${eventStatus}</span>
                    </div>
                `;
                recentEventsList.appendChild(eventItem);
            }
        } catch (error) {
            console.error("Error loading recent events:", error);
        }
    }
    
    // Make sure these functions are globally available
    window.loadRecentEvents = loadRecentEvents;
    window.getEventStatus = getEventStatus;
    </script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCg7vwuwfN8oWSMagExshHCtMHnxzc7pH0",
        authDomain: "event-ticket-fc753.firebaseapp.com",
        projectId: "event-ticket-fc753",
        storageBucket: "event-ticket-fc753.firebasestorage.app",
        messagingSenderId: "216313948465",
        appId: "1:216313948465:web:4c4b8eb9fbb4257fe6e810",
        measurementId: "G-SGBZK0BYVL"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);

    // Define the function
</script>

<script>
    // Add this after Firebase initialization
    document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
            try {
                // First sign out from Firebase
                await auth.signOut();
                
                // Clear all storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Get the base URL for GitHub Pages
                const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
                
                // Force redirect to index page with correct path
                window.location.replace(`${baseUrl}/index.html`);
                
                // Prevent back navigation
                window.history.pushState(null, '', `${baseUrl}/index.html`);
                
            } catch (error) {
                console.error("Logout error:", error);
                // Force redirect even if there's an error
                const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
                window.location.replace(`${baseUrl}/index.html`);
            }
        });
    }
});
</script>

<!-- Add reference to external JavaScript file -->
<script type="module" src="scripts/admin.js"></script>
    <!-- Loader iframe -->

    <!-- Add this function to handle scheduler sections -->
    <script>
    function toggleScheduleSection(type) {
        const section = document.getElementById(`${type}ScheduleSection`);
        const checkbox = document.getElementById(`enable${type.charAt(0).toUpperCase() + type.slice(1)}Schedule`);
        
        if (checkbox.checked) {
            section.style.display = 'block';
            // Set minimum date to today for publish date
            if (type === 'publish') {
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                document.getElementById('publishDate').min = today.toISOString().slice(0, 16);
            }
            // Set minimum date to event date for hide date
            if (type === 'hide') {
                const eventDate = document.getElementById('eventDate').value;
                if (eventDate) {
                    document.getElementById('hideDate').min = eventDate;
                }
            }
        } else {
            section.style.display = 'none';
            document.getElementById(`${type}Date`).value = '';
        }
    }

    // Add event listener for event date change
    document.getElementById('eventDate').addEventListener('change', function() {
        const hideDate = document.getElementById('hideDate');
        if (hideDate && this.value) {
            hideDate.min = this.value;
        }
    });

    // Make the function globally available
    window.toggleScheduleSection = toggleScheduleSection;
    </script>

    <script>
    async function handleEventSelect() {
        const eventSelect = document.getElementById('eventSelect');
        const ticketInfoDiv = document.getElementById('ticketInfo');
        const generateBtn = document.getElementById('generateTicketBtn');
        
        if (!eventSelect.value) {
            ticketInfoDiv.innerHTML = '';
            generateBtn.disabled = true;
            return;
        }

        try {
            // Get event details
            const eventDoc = await getDoc(doc(db, 'events', eventSelect.value));
            if (!eventDoc.exists()) {
                throw new Error('Event not found');
            }

            const event = eventDoc.data();
            const now = new Date();
            const bookingStart = new Date(event.bookingStartDate);
            const bookingEnd = new Date(event.bookingDeadline);

            // Check if booking is allowed
            if (now < bookingStart) {
                ticketInfoDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-clock"></i>
                        Booking hasn't started yet. Starts on ${bookingStart.toLocaleDateString()} at ${bookingStart.toLocaleTimeString()}
                    </div>
                `;
                generateBtn.disabled = true;
                return;
            }

            if (now > bookingEnd) {
                ticketInfoDiv.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-times-circle"></i>
                        Booking period has ended
                    </div>
                `;
                generateBtn.disabled = true;
                return;
            }

            // Check ticket availability
            let availabilityHTML = '';
            let canGenerate = false;

            if (event.eventType === 'hybrid') {
                const venueAvailable = event.tickets?.venue?.available || 0;
                const onlineAvailable = event.tickets?.online?.available || 0;
                
                availabilityHTML = `
                    <div class="ticket-availability">
                        <h4>Ticket Availability:</h4>
                        <div class="availability-item ${venueAvailable > 0 ? 'available' : 'sold-out'}">
                            <span>Venue Tickets:</span>
                            <span>${venueAvailable} available</span>
                            <span>Price: â‚¹${event.tickets?.venue?.price || 0}</span>
                        </div>
                        <div class="availability-item ${onlineAvailable > 0 ? 'available' : 'sold-out'}">
                            <span>Online Tickets:</span>
                            <span>${onlineAvailable} available</span>
                            <span>Price: â‚¹${event.tickets?.online?.price || 0}</span>
                        </div>
                    </div>
                `;
                canGenerate = venueAvailable > 0 || onlineAvailable > 0;
            } else {
                const available = event.availableTickets || 0;
                availabilityHTML = `
                    <div class="ticket-availability">
                        <h4>Ticket Availability:</h4>
                        <div class="availability-item ${available > 0 ? 'available' : 'sold-out'}">
                            <span>Available Tickets:</span>
                            <span>${available}</span>
                            <span>Price: â‚¹${event.price || 0}</span>
                        </div>
                    </div>
                `;
                canGenerate = available > 0;
            }

            ticketInfoDiv.innerHTML = `
                <div class="event-info">
                    <h3>${event.name}</h3>
                    <p><i class="fas fa-calendar"></i> ${new Date(event.date).toLocaleDateString()}</p>
                    ${availabilityHTML}
                </div>
            `;

            generateBtn.disabled = !canGenerate;
            if (!canGenerate) {
                ticketInfoDiv.innerHTML += `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        No tickets available for this event
                    </div>
                `;
            }

        } catch (error) {
            console.error('Error fetching event details:', error);
            ticketInfoDiv.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    Error fetching event details
                </div>
            `;
            generateBtn.disabled = true;
        }
    }
    </script>

    <script>
    function toggleMoreMenu() {
        const moreMenu = document.getElementById('moreMenu');
        const moreButton = document.querySelector('.mobile-nav-item[onclick="toggleMoreMenu()"]');
        
        moreMenu.classList.toggle('active');
        moreButton.classList.toggle('active');
        
        // Update the More button icon
        const moreIcon = moreButton.querySelector('i');
        if (moreMenu.classList.contains('active')) {
            moreIcon.classList.remove('fa-ellipsis-h');
            moreIcon.classList.add('fa-times');
        } else {
            moreIcon.classList.remove('fa-times');
            moreIcon.classList.add('fa-ellipsis-h');
        }
    }

    // Close more menu when clicking outside
    document.addEventListener('click', function(event) {
        const moreMenu = document.getElementById('moreMenu');
        const moreButton = document.querySelector('.mobile-nav-item[onclick="toggleMoreMenu()"]');
        
        if (!moreButton.contains(event.target) && !moreMenu.contains(event.target)) {
            moreMenu.classList.remove('active');
            moreButton.classList.remove('active');
            const moreIcon = moreButton.querySelector('i');
            moreIcon.classList.remove('fa-times');
            moreIcon.classList.add('fa-ellipsis-h');
        }
    });
    </script>

    <script>
    // Global logout function
    function logout() {
        try {
            // First sign out from Firebase
            auth.signOut().then(() => {
                // Clear all storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Get the base URL for GitHub Pages
                const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
                
                // Force redirect to index page with correct path
                window.location.replace(`${baseUrl}/index.html`);
                
                // Prevent back navigation
                window.history.pushState(null, '', `${baseUrl}/index.html`);
                
            }).catch((error) => {
                console.error("Error signing out:", error);
                // Force redirect even if there's an error
                const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
                window.location.replace(`${baseUrl}/index.html`);
            });
        } catch (error) {
            console.error("Logout error:", error);
            // Force redirect even if there's an error
            const baseUrl = window.location.pathname.includes('/Event-Ticket-Management') ? '/Event-Ticket-Management' : '';
            window.location.replace(`${baseUrl}/index.html`);
        }
    }

    // Make logout function globally available
    window.logout = logout;
</script>

</body>
</html>

<!-- Add this right before closing body tag -->
<div class="mobile-nav">
    <div class="mobile-nav-items">
        <div class="mobile-nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
        </div>
        
        <div class="mobile-nav-item" onclick="showSection('events')">
            <i class="fas fa-calendar-alt"></i>
            <span>Events</span>
        </div>
        
        <div class="mobile-nav-item" onclick="showSection('tickets')">
            <i class="fas fa-ticket-alt"></i>
            <span>Tickets</span>
        </div>
        
        <div class="mobile-nav-item" onclick="showSection('passes')">
            <i class="fas fa-id-card"></i>
            <span>Passes</span>
        </div>
        
        <div class="mobile-nav-item" onclick="toggleMoreMenu()">
            <i class="fas fa-ellipsis-h"></i>
            <span>More</span>
        </div>
    </div>

    <!-- Move more menu inside mobile-nav -->
    <div class="more-menu" id="moreMenu">
        <div class="mobile-nav-item" onclick="showSection('verification')">
            <i class="fas fa-check-circle"></i>
            <span>Verify</span>
        </div>
        <div class="mobile-nav-item" onclick="showSection('generateTicket')">
            <i class="fas fa-plus-circle"></i>
            <span>Generate</span>
        </div>
    </div>
</div>

<script>
    // Functions for handling event category and pricing type
    function handleEventCategoryChange() {
        const categorySelect = document.getElementById('eventCategory');
        const otherCategoryGroup = document.getElementById('otherCategoryGroup');
        const otherCategoryInput = document.getElementById('otherCategoryName');
        
        if (categorySelect.value === 'other') {
            otherCategoryGroup.style.display = 'block';
            otherCategoryInput.required = true;
        } else {
            otherCategoryGroup.style.display = 'none';
            otherCategoryInput.required = false;
            otherCategoryInput.value = '';
        }
    }

    function handlePricingTypeChange() {
    const pricingType = document.getElementById('eventPricingType').value;
    const priceInputs = [
        document.getElementById('eventPrice'),
        document.getElementById('venueTicketPrice'),
        document.getElementById('onlineTicketPrice')
    ];
    
    priceInputs.forEach(input => {
        if (input) {
            if (pricingType === 'free') {
                input.value = '0';
                input.readOnly = true;
            } else {
                input.value = '';
                input.readOnly = false;
            }
        }
    });
}

    // Update openEditModal to handle category and pricing type
    const originalOpenEditModal = window.openEditModal;
    window.openEditModal = function(eventId, eventData) {
        try {
            if (originalOpenEditModal) {
                originalOpenEditModal(eventId, eventData);
            }

            // Set category
            const categorySelect = document.getElementById('eventCategory');
            if (categorySelect) {
                if (eventData.category === 'other') {
                    categorySelect.value = 'other';
                    document.getElementById('otherCategoryName').value = eventData.customCategory || '';
                    document.getElementById('otherCategoryGroup').style.display = 'block';
                } else {
                    categorySelect.value = eventData.category || '';
                }
            }

            // Set pricing type
            const pricingTypeSelect = document.getElementById('eventPricingType');
            if (pricingTypeSelect) {
                pricingTypeSelect.value = eventData.pricingType || 'paid';
                handlePricingTypeChange();
            }

        } catch (error) {
            console.error("Error in enhanced openEditModal:", error);
        }
    };

    // Update clearEventForm to reset new fields
    const originalClearEventForm = window.clearEventForm;
    window.clearEventForm = function() {
        if (originalClearEventForm) {
            originalClearEventForm();
        }

        // Reset category fields
        const categorySelect = document.getElementById('eventCategory');
        const otherCategoryGroup = document.getElementById('otherCategoryGroup');
        const otherCategoryInput = document.getElementById('otherCategoryName');
        
        if (categorySelect) categorySelect.value = '';
        if (otherCategoryGroup) otherCategoryGroup.style.display = 'none';
        if (otherCategoryInput) otherCategoryInput.value = '';

        // Reset pricing type
        const pricingTypeSelect = document.getElementById('eventPricingType');
        if (pricingTypeSelect) {
            pricingTypeSelect.value = '';
            handlePricingTypeChange();
        }
    };

    // Make functions globally available
    window.handleEventCategoryChange = handleEventCategoryChange;
    window.handlePricingTypeChange = handlePricingTypeChange;
</script>

<script>
    // Function to generate random 5-digit number
    function generateRandomFiveDigits() {
        return Math.floor(10000 + Math.random() * 90000).toString();
    }

    // Function to get current year
    function getCurrentYear() {
        return new Date().getFullYear().toString();
    }

    // Update event ID generation
    function generateEventId() {
        const randomNum = generateRandomFiveDigits();
        const year = getCurrentYear();
        return `EVT-${randomNum}-${year}`;
    }

    // Update ticket ID generation
    function generateTicketId() {
        const randomNum = generateRandomFiveDigits();
        const year = getCurrentYear();
        return `TIX-${randomNum}-${year}`;
    }

    // Update pass ID generation
    function generatePassId() {
        const randomNum = generateRandomFiveDigits();
        const year = getCurrentYear();
        return `PASS-${randomNum}-${year}`;
    }

    // Make functions globally available
    window.generateEventId = generateEventId;
    window.generateTicketId = generateTicketId;
    window.generatePassId = generatePassId;
</script>



<script>


    // Update the showSection function to load active events when switching to generate ticket section
    const originalShowSection = window.showSection;
    window.showSection = function(sectionId) {
        if (originalShowSection) {
            originalShowSection(sectionId);
        }
        
        if (sectionId === 'generateTicket') {
            loadActiveEvents();
        }
    };

    // Make the function globally available
    window.loadActiveEvents = loadActiveEvents;
</script>

</body>
</html>